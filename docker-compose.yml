version: "3.7"
services:
    redis:
        image: redis:5-alpine
        ports:
            - "6379"
        networks:
            - cache
        restart: unless-stopped

    postgres:
        image: postgres:12-alpine
        ports:
            - 5432:5432
        networks:
            - database
        restart: unless-stopped

    backend:
        image: mathiasertl/django-ca:latest
        command: ./celery.sh -l ${CELERY_LOG_LEVEL:-warning}
        networks:
            - cache
            - database
        volumes:
            - ${PWD}/${DJANGO_CA_SETTINGS:-/docker/settings.yaml}:/usr/src/django-ca/settings.yaml
            - shared_ca_dir:/var/lib/django-ca/certs/ca/shared/
            - ocsp_key_dir:/var/lib/django-ca/certs/ocsp/
        environment:
            DJANGO_CA_SECRET_KEY: ${DJANGO_CA_SECRET_KEY:-}
            DJANGO_CA_SECRET_KEY_FILE: ${DJANGO_CA_SECRET_KEY_FILE:-}
            DJANGO_CA_HOSTNAME: ${DJANGO_CA_HOSTNAME:-localhost}
            DJANGO_CA_SETTINGS: settings.yaml:compose.yaml
        restart: unless-stopped

    frontend:
        image: mathiasertl/django-ca:latest
        ports:
            - 8000:8000
        networks:
            - cache
            - database
            - frontend
        volumes:
            - ${PWD}/${DJANGO_CA_SETTINGS:-docker/settings.yaml}:/usr/src/django-ca/settings.yaml
            - static:/usr/share/django-ca/static/
            - shared_ca_dir:/var/lib/django-ca/certs/ca/shared/
            - ocsp_key_dir:/var/lib/django-ca/certs/ocsp/
        environment:
            DJANGO_CA_HOSTNAME: ${DJANGO_CA_HOSTNAME:-localhost}
            DJANGO_CA_SETTINGS: settings.yaml:compose.yaml
            DJANGO_CA_SECRET_KEY: ${DJANGO_CA_SECRET_KEY:-}
            DJANGO_CA_SECRET_KEY_FILE: ${DJANGO_CA_SECRET_KEY_FILE:-}
            DJANGO_CA_UWSGI_INI: /usr/src/django-ca/uwsgi/uwsgi.ini
        restart: unless-stopped

    webserver:
        image: nginx:1.17-alpine
        environment:
            DJANGO_CA_HOSTNAME: ${DJANGO_CA_HOSTNAME:-localhost}
        ports:
            - 80:80
        networks:
            - frontend
            - public
        volumes:
            - ${PWD}/nginx.conf:/etc/nginx/conf.d/default.conf
            - static:/usr/share/nginx/html/static/

volumes:
    static:
    shared_ca_dir:
    ocsp_key_dir:

networks:
    public:
    frontend:
        internal: true
    cache:
        internal: true
    database:
        internal: true
